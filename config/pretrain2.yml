# config/pretrain_config.yml

run_name: "fusion_diffusion_pretrain_v3"
output_dir: "./checkpoints/pretrain/"

# 模型相关配置（分层：unet / encoder / vae）
model_config:
  unet:
    sample_size: 160  # the target image resolution with vae
    in_channels: 4  # the number of input channels, 3 for RGB images
    out_channels: 4  # the number of output channels
    layers_per_block: 2  # how many ResNet layers to use per UNet block
    block_out_channels: [128, 128, 256, 256, 512, 512]  # the number of output channels for each UNet block
    down_block_types:
      - "DownBlock2D"  # a regular ResNet downsampling block
      - "DownBlock2D"
      - "DownBlock2D"
      - "DownBlock2D"
      - "AttnDownBlock2D"  # a ResNet downsampling block with spatial self-attention
      - "DownBlock2D"
    up_block_types:
      - "UpBlock2D"  # a regular ResNet upsampling block
      - "AttnUpBlock2D"  # a ResNet upsampling block with spatial self-attention
      - "UpBlock2D"
      - "UpBlock2D"
      - "UpBlock2D"
      - "UpBlock2D"
    cross_attention_dim: 512

  encoder:
    in_channels: 8
    out_channels: 512
    base_channels: 128
    layer_blocks: [2, 2, 2]

  vae:
    pretrain: "/home/zhangran/desktop/myProject/playground/sd-vae-ft-mse"


diffusion:
  num_inference_steps: 20
  num_train_timesteps: 1000
  
# 训练相关配置
training:
  num_epochs: 5000
  train_batch_size: 16
  learning_rate: 2.0e-5
  optimizer:
    type: "AdamW"
    args:
      weight_decay: 0.0001
      betas: [0.9, 0.999]
  # Scheduler 类型留空（由代码使用 get_cosine_schedule_with_warmup 构建），保留旧字段兼容
  scheduler:
    type: "CosineAnnealingLR"
    args:
      T_max: 5000
      eta_min: 1.0e-6

  # 优化器/训练细节
  loss_function: "l2"
  test_freq: 50
  save_freq: 250

  # step 级别 warmup，优先使用 lr_warmup_steps（步数）。若为空可配置 warmup.warmup_steps 保持兼容。
  lr_warmup_steps: 500
  # 备用兼容项（旧配置）
  warmup:
    warmup_steps: 500

  # 混合精度与梯度累积
  mixed_precision: "bf16"       # "no", "fp16" or "bf16"
  gradient_accumulation_steps: 1
  max_grad_norm: 1.0

# 数据集配置
datasets:
  MSRS:
    train:
      dir_A: './data/MSRS-main/MSRS-main/train/vi'
      dir_B: './data/MSRS-main/MSRS-main/train/ir'
      dir_C: './data/MSRS-main/MSRS-main/train/label'
    test:
      dir_A: './data/MSRS-main/MSRS-main/test/vi'
      dir_B: './data/MSRS-main/MSRS-main/test/ir'

train_dataset:
  name: "MSRS"

test_sets:
  - name: "MSRS"
    test_batch_size: 4

pipeline:
  # 是否在解码前把 vis 的 latent 加回到生成的 latent（残差 shortcut）。
  # 默认关闭（留空或 False 表示关闭）
  use_shortcut: false

  # forward_with_logprob / debug 时是否启用 DDIM logprob 计算（会使用 pipeline 内的 ddim_step_with_logprob）
  # 仅用于诊断/研究目的，默认关闭
  use_ddim_logprob: false